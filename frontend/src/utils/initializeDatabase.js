// Цей файл містить функцію для ініціалізації Firebase бази даних з демо-даними

import { db } from '../config/firebase';
import { collection, getDocs, addDoc, query, where, doc, deleteDoc } from 'firebase/firestore';

// Демо-дані для турів
const initialTours = [
    {
        name: "Антична Туреччина",
        description: "Відправляйтесь у подорож по стародавніх руїнах Туреччини, щоб дізнатися більше про історію античних цивілізацій. Відвідайте легендарні пам'ятки, такі як Ефес, Памуккале та міста на узбережжі Егейського моря, пориньте в атмосферу античної культури та архітектури.",
        price: 18500,
        location: "Стамбул, Ефес, Анкара",
        imageUrl: "photo/turkey1.jpg",
        country: "turkey",
        duration: "7 днів",
        groupSize: "15 осіб",
        rating: 4.8,
        reviewCount: 24,
        includes: [
            "Проживання в готелях 4*",
            "Сніданки",
            "Трансфери аеропорт-готель-аеропорт",
            "Екскурсії з гідом",
            "Вхідні квитки до музеїв"
        ],
        program: [
            "Прибуття в Стамбул, розміщення в готелі, вільний час для прогулянок містом.",
            "Екскурсія по Стамбулу: Блакитна мечеть, Софія Київська, палац Топкапи.",
            "Переліт до Ізміру, трансфер до Ефесу, екскурсія по античному місту.",
            "Відвідування Памуккале і Хієраполіса.",
            "Переїзд до Фетхіє, вільний час на пляжі.",
            "Екскурсія на човні до затоплених руїн Кекови.",
            "Повернення в Даламан, виліт додому."
        ],
        cities: [
            { name: "Стамбул", lat: 41.0082, lng: 28.9784 },
            { name: "Ефес", lat: 37.9398, lng: 27.3436 },
            { name: "Памуккале", lat: 37.9137, lng: 29.1187 },
            { name: "Фетхіє", lat: 36.621, lng: 29.1153 },
            { name: "Даламан", lat: 36.7092, lng: 28.782 }
        ]
    },
    {
        name: "All inclusive в Бодрумі",
        description: "Насолоджуйтесь відпочинком на узбережжі Туреччини в Бодрумі, де ви зможете розслабитися на сонячних пляжах, смачно поїсти в розкішних готелях з системою All Inclusive та отримати максимальне задоволення від розваг та відпочинку.",
        price: 22000,
        location: "Бодрум, Мармарис",
        imageUrl: "photo/turkey2.webp",
        country: "turkey",
        duration: "5 днів",
        groupSize: "без обмежень",
        rating: 4.5,
        reviewCount: 32,
        includes: [
            "Проживання в готелі 5* (All Inclusive)",
            "Трансфери аеропорт-готель-аеропорт",
            "Користування всіма послугами готелю",
            "Страхування"
        ],
        program: [
            "Прибуття в Бодрум, розміщення в готелі, відпочинок.",
            "Відпочинок на пляжі, користування басейнами та аквапарком готелю.",
            "Відпочинок на пляжі, вечірні розважальні програми.",
            "Вільний день для відпочинку або додаткових екскурсій за бажанням.",
            "Виселення з готелю, трансфер в аеропорт."
        ],
        cities: [
            { name: "Бодрум", lat: 37.0344, lng: 27.4305 }
        ]
    },
    {
        name: "Кападокія та повітряні кулі",
        description: "Досліджуйте неймовірні пейзажі Кападокії, відомі своїми скельними формаціями та стародавніми печерами. Однією з головних атракцій стане незабутня прогулянка на повітряних кулях на світанку, що подарує вам незабутні враження.",
        price: 20000,
        location: "Гьореме, Учисар",
        imageUrl: "photo/turkey3.jpg",
        country: "turkey",
        duration: "6 днів",
        groupSize: "12 осіб",
        rating: 4.9,
        reviewCount: 45,
        includes: [
            "Проживання в печерному готелі",
            "Сніданки",
            "Трансфери аеропорт-готель-аеропорт",
            "Політ на повітряній кулі",
            "Екскурсії з гідом"
        ],
        program: [
            "Прибуття в Невшехір, трансфер до готелю в Гьореме.",
            "Ранній підйом для польоту на повітряній кулі на світанку. Після сніданку - екскурсія Долиною Любові.",
            "Екскурсія підземним містом Деринкую та Долиною Ілхара.",
            "Відвідування Музею під відкритим небом в Гьореме та фортеці Учисар.",
            "Екскурсія до Аваносу, майстер-клас з гончарства.",
            "Виселення з готелю, трансфер в аеропорт."
        ],
        cities: [
            { name: "Невшехір", lat: 38.6246, lng: 34.7139 },
            { name: "Гьореме", lat: 38.6448, lng: 34.8291 },
            { name: "Ургуп", lat: 38.6312, lng: 34.9147 },
            { name: "Аванос", lat: 38.6953, lng: 34.8471 }
        ]
    },
    {
        name: "Швейцарські Альпи",
        description: "Відкрийте для себе красу Альп, піднімаючись на гірські вершини та милуючись чудовими краєвидами. Погуляйте по гірських курортах, насолоджуйтесь катанням на лижах, пішими прогулянками та атмосферою швейцарських гірських містечок.",
        price: 30000,
        location: "Цюріх, Женева, Інтерлакен",
        imageUrl: "photo/switzerland1.jpg",
        country: "switzerland",
        duration: "7 днів",
        groupSize: "10 осіб",
        rating: 4.7,
        reviewCount: 18,
        includes: [
            "Проживання в готелях 4*",
            "Сніданки",
            "Проїзний Swiss Travel Pass на всі види транспорту",
            "Підйом на гору Маттерхорн",
            "Екскурсії з гідом"
        ],
        program: [
            "Прибуття в Цюріх, розміщення в готелі, вечірня прогулянка містом.",
            "Переїзд до Церматту, підйом на гору Маттерхорн.",
            "Переїзд до Інтерлакену, відвідування Юнгфрауйох.",
            "Подорож до Женеви, екскурсія містом.",
            "Відвідування Лугано та озера Лугано.",
            "Екскурсія до Люцерну, прогулянка містом та озером.",
            "Повернення до Цюріху, виліт додому."
        ],
        cities: [
            { name: "Церматт", lat: 46.0207, lng: 7.7491 },
            { name: "Інтерлакен", lat: 46.6863, lng: 7.8632 },
            { name: "Женева", lat: 46.2044, lng: 6.1432 },
            { name: "Лугано", lat: 46.0037, lng: 8.9511 },
            { name: "Люцерн", lat: 47.0502, lng: 8.3093 }
        ]
    },
    {
        name: "Казкові міста Швейцарії",
        description: "Окуніться в казкову атмосферу старовинних швейцарських міст, таких як Цюрих, Женеву та Берн. Прогуляйтесь вузькими вулицями, насолоджуйтесь архітектурними пам'ятками та природною красою, відвідайте музеї та чарівні кав'ярні.",
        price: 25000,
        location: "Люцерн, Берн, Цюріх",
        imageUrl: "photo/switzerland2.jpg",
        country: "switzerland",
        duration: "5 днів",
        groupSize: "12 осіб",
        rating: 4.6,
        reviewCount: 22,
        includes: [
            "Проживання в готелях 4*",
            "Сніданки",
            "Проїзний Swiss Travel Pass на всі види транспорту",
            "Екскурсії з гідом",
            "Вхідні квитки до музеїв"
        ],
        program: [
            "Прибуття в Цюріх, розміщення в готелі, екскурсія містом.",
            "Переїзд до Берну, відвідування Старого міста, внесеного до списку ЮНЕСКО.",
            "Переїзд до Женеви, екскурсія містом, відвідування Музею годинників.",
            "Подорож до Лугано, прогулянка озером та старим містом.",
            "Повернення до Цюріху, вільний час для шопінгу, виліт додому."
        ],
        cities: [
            { name: "Цюрих", lat: 47.3769, lng: 8.5417 },
            { name: "Берн", lat: 46.948, lng: 7.4474 },
            { name: "Женева", lat: 46.2044, lng: 6.1432 },
            { name: "Лугано", lat: 46.0037, lng: 8.9511 }
        ]
    },
    {
        name: "Люцерн та гірські озера",
        description: "Проведіть час у Люцерні та навколо неймовірних гірських озер Швейцарії. Насолоджуйтесь круїзами по озерах, підйомами на вершини гір та оглядами живописних краєвидів, що залишать у вас незабутні враження.",
        price: 27000,
        location: "Люцерн, Церматт, Шпіц",
        imageUrl: "photo/switzerland3.jpg",
        country: "switzerland",
        duration: "4 дні",
        groupSize: "8 осіб",
        rating: 4.8,
        reviewCount: 15,
        includes: [
            "Проживання в готелях 4*",
            "Сніданки",
            "Круїз по Люцернському озеру",
            "Проїзний на всі види транспорту",
            "Екскурсії з гідом"
        ],
        program: [
            "Прибуття в Люцерн, розміщення в готелі, вечірня прогулянка містом.",
            "Круїз по Люцернському озеру, відвідування гори Пілатус.",
            "Переїзд до Цюріху, екскурсія містом та озером.",
            "Подорож до Інтерлакену, розташованого між озерами Тун і Бріенц."
        ],
        cities: [
            { name: "Люцерн", lat: 47.0502, lng: 8.3093 },
            { name: "Цюріх", lat: 47.3769, lng: 8.5417 },
            { name: "Інтерлакен", lat: 46.6863, lng: 7.8632 }
        ]
    },
    {
        name: "Традиційна Японія",
        description: "Відкрийте для себе традиційну Японію: відвідайте стародавні храми, замки та села, де збереглися звичаї та культура цієї дивовижної країни. Познайомтесь із японськими садами, мистецтвом чайної церемонії та місцевими ремеслами.",
        price: 35000,
        location: "Кіото, Нара, Токіо",
        imageUrl: "photo/japan1.webp",
        country: "japan",
        duration: "8 днів",
        groupSize: "10 осіб",
        rating: 4.9,
        reviewCount: 28,
        includes: [
            "Проживання в готелях 3-4*",
            "Сніданки",
            "Проїзний Japan Rail Pass",
            "Екскурсії з гідом",
            "Майстер-клас з чайної церемонії"
        ],
        program: [
            "Прибуття в Кіото, розміщення в готелі, вільний час.",
            "Екскурсія по храмах Кіото: Кінкаку-дзі, Рьоан-дзі, Кійоміузу-дера.",
            "Відвідування Нари, храму Тодай-дзі та парку з оленями.",
            "Переїзд до Каназави, відвідування саду Кенроку-ен та самурайського кварталу.",
            "Переїзд до Осаки, відвідування замку Осаки та кварталу Дотонборі.",
            "Переїзд до Хірацуки, відвідування храму Кота-ку-дзі та гарячих джерел.",
            "Вільний день для додаткових екскурсій або шопінгу.",
            "Виселення з готелю, трансфер в аеропорт."
        ],
        cities: [
            { name: "Кіото", lat: 35.0116, lng: 135.7681 },
            { name: "Нара", lat: 34.6851, lng: 135.8048 },
            { name: "Каназава", lat: 36.5944, lng: 136.6255 },
            { name: "Осака", lat: 34.6937, lng: 135.5023 },
            { name: "Хірацука", lat: 35.3192, lng: 139.3422 }
        ]
    },
    {
        name: "Сакура та весняна Японія",
        description: "Насолоджуйтесь неймовірною красою Японії під час цвітіння сакури. Побачте безліч рожевих квітів, прогуляйтесь по парках Токіо та Кіото, відвідайте храми та насолоджуйтесь атмосферою весняної Японії.",
        price: 40000,
        location: "Токіо, Осака, Хаконе",
        imageUrl: "photo/japan2.jpg",
        country: "japan",
        duration: "7 днів",
        groupSize: "12 осіб",
        rating: 5.0,
        reviewCount: 35,
        includes: [
            "Проживання в готелях 4*",
            "Сніданки",
            "Проїзний Japan Rail Pass",
            "Екскурсії з гідом",
            "Відвідування фестивалю сакури"
        ],
        program: [
            "Прибуття в Токіо, розміщення в готелі, вечірня прогулянка районом Сібуя.",
            "Екскурсія по Токіо: парк Уено для спостереження за сакурою, храм Сенсо-дзі, район Акіхабара.",
            "Переїзд до Кіото, відвідування храмів та садів, де цвіте сакура.",
            "Екскурсія до Нари, відвідування парку з оленями та храму Тодай-дзі.",
            "Переїзд до Хіросіми, відвідування Меморіального парку миру.",
            "Переїзд до Осаки, відвідування замку Осаки та вечірня прогулянка районом Дотонборі.",
            "Повернення до Токіо, вільний час для шопінгу, виліт додому."
        ],
        cities: [
            { name: "Токіо", lat: 35.6762, lng: 139.6503 },
            { name: "Кіото", lat: 35.0116, lng: 135.7681 },
            { name: "Нара", lat: 34.6851, lng: 135.8048 },
            { name: "Хіросіма", lat: 34.3853, lng: 132.4553 },
            { name: "Осака", lat: 34.6937, lng: 135.5023 }
        ]
    },
    {
        name: "Неоновий Токіо",
        description: "Відчуйте всю енергію сучасного Токіо, де поєднуються висотки, неонові вивіски та традиційна культура. Відвідайте модні райони, такі як Шибуя та Сібуя, пориньте у технологічні інновації та насолоджуйтесь нічним життям мегаполісу.",
        price: 32000,
        location: "Токіо, Осака",
        imageUrl: "photo/japan3.jpg",
        country: "japan",
        duration: "5 днів",
        groupSize: "10 осіб",
        rating: 4.7,
        reviewCount: 20,
        includes: [
            "Проживання в готелі 4*",
            "Сніданки",
            "Проїзний на громадський транспорт",
            "Екскурсії з гідом",
            "Вхідні квитки до музеїв"
        ],
        program: [
            "Прибуття в Токіо, розміщення в готелі, вечірня прогулянка районом Сібуя.",
            "Відвідування району Акіхабара, музею цифрових технологій TeamLab Borderless.",
            "Екскурсія по Токіо: Токійська вежа, район Роппонгі, панорамний майданчик Tokyo Skytree.",
            "Відвідування парку Одайба, музею майбутнього Miraikan, вечеря в тематичному ресторані.",
            "Вільний день для шопінгу в районах Гіндза та Харадзюку, виліт додому."
        ],
        cities: [
            { name: "Токіо", lat: 35.6762, lng: 139.6503 }
        ]
    }
];

// Функція для додавання демо-турів в базу даних
export const initializeDatabase = async () => {
    try {
        // Перевіряємо, чи вже є тури в базі даних
        const toursRef = collection(db, 'tours');
        const toursSnapshot = await getDocs(toursRef);

        if (toursSnapshot.empty) {
            console.log('Ініціалізація бази даних з демо-турами...');

            // Додаємо всі тури
            const addedTours = await Promise.all(
                initialTours.map(tour => addDoc(collection(db, 'tours'), tour))
            );

            console.log(`Додано ${addedTours.length} демо-турів.`);
            return true;
        } else {
            console.log('База даних вже містить тури. Перевіряємо наявність дублікатів...');

            // Перевіряємо наявність дублікатів за назвою туру
            const existingTours = toursSnapshot.docs.map(doc => ({
                id: doc.id,
                name: doc.data().name
            }));

            const tourNameCounts = {};
            existingTours.forEach(tour => {
                tourNameCounts[tour.name] = (tourNameCounts[tour.name] || 0) + 1;
            });

            const duplicateNames = Object.entries(tourNameCounts)
                .filter(([name, count]) => count > 1)
                .map(([name]) => name);

            if (duplicateNames.length > 0) {
                console.log(`Знайдено дублікати турів за назвою: ${duplicateNames.join(', ')}`);
                console.log('Видаляємо дублікати...');

                // Для кожної назви з дублікатами
                for (const name of duplicateNames) {
                    // Знаходимо всі тури з такою назвою
                    const duplicatesQuery = query(
                        collection(db, 'tours'),
                        where("name", "==", name)
                    );

                    const duplicatesSnapshot = await getDocs(duplicatesQuery);
                    const duplicates = duplicatesSnapshot.docs;

                    // Залишаємо перший тур, видаляємо інші
                    for (let i = 1; i < duplicates.length; i++) {
                        await deleteDoc(doc(db, 'tours', duplicates[i].id));
                        console.log(`Видалено дублікат туру "${name}" з ID ${duplicates[i].id}`);
                    }
                }

                console.log('Дублікати видалено.');
                return true;
            }

            console.log('Дублікатів не знайдено.');
            return false;
        }
    } catch (error) {
        console.error('Помилка при ініціалізації бази даних:', error);
        return false;
    }
};

// Функція для перевірки та додавання демо-відгуків
export const addDemoReviews = async () => {
    try {
        // Перевіряємо, чи вже є відгуки в базі даних
        const reviewsRef = collection(db, 'reviews');
        const reviewsSnapshot = await getDocs(reviewsRef);

        if (reviewsSnapshot.empty) {
            console.log('Додавання демо-відгуків...');

            // Отримуємо всі тури
            const toursRef = collection(db, 'tours');
            const toursSnapshot = await getDocs(toursRef);
            const tours = toursSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Для кожного туру додаємо кілька відгуків
            for (const tour of tours) {
                // Кількість відгуків залежить від reviewCount у турі
                const reviewCount = tour.reviewCount || 3;

                for (let i = 0; i < Math.min(reviewCount, 5); i++) {
                    const reviewData = {
                        tourId: tour.id,
                        userId: `demo-user-${i}`,
                        userName: `Користувач ${i + 1}`,
                        text: getDemoReviewText(i),
                        rating: getRandomRating(tour.rating),
                        createdAt: new Date(Date.now() - (i * 86400000)) // Різні дати для відгуків
                    };

                    await addDoc(collection(db, 'reviews'), reviewData);
                }
            }

            console.log('Демо-відгуки успішно додані.');
            return true;
        } else {
            console.log('База даних вже містить відгуки. Пропускаємо додавання демо-відгуків.');
            return false;
        }
    } catch (error) {
        console.error('Помилка при додаванні демо-відгуків:', error);
        return false;
    }
};

// Допоміжні функції
function getDemoReviewText(index) {
    const reviewTexts = [
        "Чудовий тур! Все було організовано на найвищому рівні. Гід знав багато цікавих фактів та історій. Рекомендую всім!",
        "Дуже задоволений поїздкою. Готелі були комфортні, екскурсії цікаві. Єдиний мінус - довгий переїзд, але воно того варте.",
        "Супер відпочинок! Природа неймовірна, багато гарних місць для фотографування. Обов'язково повернуся сюди ще раз.",
        "Організація туру на високому рівні. Все відбувалось за графіком, без затримок. Гід був дуже привітним та знаючим.",
        "Неймовірні враження від поїздки! Особливо сподобалась кухня та гостинність місцевих жителів. Раджу цей тур всім, хто хоче відпочити з комфортом."
    ];

    return reviewTexts[index % reviewTexts.length];
}

function getRandomRating(baseRating) {
    // Генеруємо випадковий рейтинг у межах +/- 0.5 від базового рейтингу туру
    const min = Math.max(1, (baseRating || 4) - 0.5);
    const max = Math.min(5, (baseRating || 4) + 0.5);
    return Math.round((Math.random() * (max - min) + min) * 10) / 10; // Округлюємо до 1 знаку після коми
}